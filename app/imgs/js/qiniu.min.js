function QiniuJsSDK(){var a;if(window.location.protocol==="https:"){a="https://up.qbox.me"}else{a="http://upload.qiniu.com"}this.detectIEVersion=function(){var c=4,e=document.createElement("div"),d=e.getElementsByTagName("i");while(e.innerHTML="<!--[if gt IE "+c+"]><i></i><![endif]-->",d[0]){c++}return c>4?c:false};this.isImage=function(e){var g,h="";var c=["png","jpg","jpeg","gif","bmp"];var j=/\.([a-zA-Z0-9]+)(\?|\@|$)/;if(!e||!j.test(e)){return false}g=j.exec(e);h=g[1].toLowerCase();for(var f=0,d=c.length;f<d;f++){if(h===c[f]){return true}}return false};this.getFileExtension=function(c){var d=c.split(".");var e;if(d.length===1||(d[0]===""&&d.length===2)){e=""}else{e=d.pop().toLowerCase()}return e};this.utf8_encode=function(c){if(c===null||typeof c==="undefined"){return""}var k=(c+"");var l="",d,g,e=0;d=g=0;e=k.length;for(var f=0;f<e;f++){var j=k.charCodeAt(f);var i=null;if(j<128){g++}else{if(j>127&&j<2048){i=String.fromCharCode((j>>6)|192,(j&63)|128)}else{if(j&63488^55296>0){i=String.fromCharCode((j>>12)|224,((j>>6)&63)|128,(j&63)|128)}else{if(j&64512^55296>0){throw new RangeError("Unmatched trail surrogate at "+f)}var h=k.charCodeAt(++f);if(h&64512^56320>0){throw new RangeError("Unmatched lead surrogate at "+(f-1))}j=((j&1023)<<10)+(h&1023)+65536;i=String.fromCharCode((j>>18)|240,((j>>12)&63)|128,((j>>6)&63)|128,(j&63)|128)}}}if(i!==null){if(g>d){l+=k.slice(d,g)}l+=i;d=g=f+1}}if(g>d){l+=k.slice(d,e)}return l};this.base64_encode=function(k){var f="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=";var e,d,c,o,n,m,l,p,j=0,q=0,h="",g=[];if(!k){return k}k=this.utf8_encode(k+"");do{e=k.charCodeAt(j++);d=k.charCodeAt(j++);c=k.charCodeAt(j++);p=e<<16|d<<8|c;o=p>>18&63;n=p>>12&63;m=p>>6&63;l=p&63;g[q++]=f.charAt(o)+f.charAt(n)+f.charAt(m)+f.charAt(l)}while(j<k.length);h=g.join("");switch(k.length%3){case 1:h=h.slice(0,-2)+"==";break;case 2:h=h.slice(0,-1)+"=";break}return h};this.URLSafeBase64Encode=function(c){c=this.base64_encode(c);return c.replace(/\//g,"_").replace(/\+/g,"-")};this.createAjax=function(d){var c={};if(window.XMLHttpRequest){c=new XMLHttpRequest();c.withCredentials="true"}else{c=new ActiveXObject("Microsoft.XMLHTTP");c.withCredentials="true"}return c};this.parseJSON=function(c){if(window.JSON&&window.JSON.parse){return window.JSON.parse(c)}if(c===null){return c}if(typeof c==="string"){c=this.trim(c);if(c){if(/^[\],:{}\s]*$/.test(c.replace(/\\(?:["\\\/bfnrt]|u[\da-fA-F]{4})/g,"@").replace(/"[^"\\\r\n]*"|true|false|null|-?(?:\d+\.|)\d+(?:[eE][+-]?\d+|)/g,"]").replace(/(?:^|:|,)(?:\s*\[)+/g,""))){return(function(){return c})()}}}};this.trim=function(c){return c===null?"":c.replace(/^\s+|\s+$/g,"")};var b=this;this.uploader=function(h){if(!h.domain){throw"uptoken_url or domain is required!"}if(!h.browse_button){throw"browse_button is required!"}var e={};var f=h.init&&h.init.Error;var l=h.init&&h.init.FileUploaded;h.init.Error=function(){};h.init.FileUploaded=function(){};b.uptoken_url=h.uptoken_url;b.token="";b.key_handler=typeof h.init.Key==="function"?h.init.Key:"";this.domain=h.domain;var k="";var c={isResumeUpload:false,resumeFilesize:0,startTime:"",currentTime:""};var d=function(){var q=b.detectIEVersion();var p,n,o;var m=(mOxie.Env.browser==="Safari"&&mOxie.Env.version<=5&&mOxie.Env.os==="Windows"&&mOxie.Env.osVersion==="7")||(mOxie.Env.browser==="Safari"&&mOxie.Env.os==="iOS"&&mOxie.Env.osVersion==="7");if(q&&q<=9&&h.chunk_size&&h.runtimes.indexOf("flash")>=0){h.chunk_size=0}else{if(m){h.chunk_size=0}else{p=20;n=4<<p;o=plupload.parseSize(h.chunk_size);if(o>n){h.chunk_size=n}}}};d();var j=function(){if(!h.uptoken){var m=b.createAjax();m.open("GET",b.uptoken_url,false);m.setRequestHeader("If-Modified-Since","0");m.onreadystatechange=function(){if(m.readyState===4&&m.status===200){b.token=m.responseText}};m.withCredentials=true;m.send()}else{b.token=h.uptoken}};var i=function(m,p,r){var o="",n=false;if(!h.save_key){n=m.getOption&&m.getOption("unique_names");n=n||(m.settings&&m.settings.unique_names);if(n){var q=b.getFileExtension(p.name);o=q?p.id+"."+q:p.id}else{if(typeof r==="function"){o=r(m,p)}else{o=p.name}}}return o};plupload.extend(e,h,{url:a,multipart_params:{token:""}});var g=new plupload.Uploader(e);g.bind("Init",function(m,n){j()});g.init();g.bind("FilesAdded",function(m,n){var o=m.getOption&&m.getOption("auto_start");o=o||(m.settings&&m.settings.auto_start);if(o){plupload.each(n,function(q,p){m.start()})}m.refresh()});g.bind("BeforeUpload",function(o,n){n.speed=n.speed||0;k="";if(h.get_new_uptoken){j()}var u=function(v,x,y){c.startTime=new Date().getTime();var w;if(h.save_key){w={token:b.token}}else{w={key:i(v,x,y),token:b.token}}var z=h.x_vars;if(z!==undefined&&typeof z==="object"){for(var A in z){if(z.hasOwnProperty(A)){if(typeof z[A]==="function"){w["x:"+A]=z[A](v,x)}else{if(typeof z[A]!=="object"){w["x:"+A]=z[A]}}}}}v.setOption({url:a,multipart:true,chunk_size:undefined,multipart_params:w})};var t=o.getOption&&o.getOption("chunk_size");t=t||(o.settings&&o.settings.chunk_size);if(g.runtime==="html5"&&t){if(n.size<t){u(o,n,b.key_handler)}else{var s=localStorage.getItem(n.name);var q=t;if(s){s=JSON.parse(s);var m=(new Date()).getTime();var r=s.time||0;var p=24*60*60*1000;if(m-r<p){if(s.percent!==100){if(n.size===s.total){n.percent=s.percent;n.loaded=s.offset;k=s.ctx;c.isResumeUpload=true;c.resumeFilesize=s.offset;if(s.offset+q>n.size){q=n.size-s.offset}}else{localStorage.removeItem(n.name)}}else{localStorage.removeItem(n.name)}}else{localStorage.removeItem(n.name)}}c.startTime=new Date().getTime();o.setOption({url:a+"/mkblk/"+q,multipart:false,chunk_size:t,required_features:"chunks",headers:{Authorization:"UpToken "+b.token},multipart_params:{}})}}else{u(o,n,b.key_handler)}});g.bind("UploadProgress",function(m,n){c.currentTime=new Date().getTime();var o=c.currentTime-c.startTime;var p=n.loaded||0;if(c.isResumeUpload){p=n.loaded-c.resumeFilesize}n.speed=(p/o*1000).toFixed(0)||0});g.bind("ChunkUploaded",function(m,o,q){var n=b.parseJSON(q.response);k=k?k+","+n.ctx:n.ctx;var p=q.total-q.offset;var r=m.getOption&&m.getOption("chunk_size");r=r||(m.settings&&m.settings.chunk_size);if(p<r){m.setOption({url:a+"/mkblk/"+p})}localStorage.setItem(o.name,JSON.stringify({ctx:k,percent:o.percent,total:q.total,offset:q.offset,time:(new Date()).getTime()}))});g.bind("Error",(function(m){return function(o,t){var r="";var q=t.file;if(q){switch(t.code){case plupload.FAILED:r="上传失败。请稍后再试。";break;case plupload.FILE_SIZE_ERROR:var p=o.getOption&&o.getOption("max_file_size");p=p||(o.settings&&o.settings.max_file_size);r="浏览器最大可上传"+p+"。更大文件请使用命令行工具。";break;case plupload.FILE_EXTENSION_ERROR:r="文件验证失败。请稍后重试。";break;case plupload.HTTP_ERROR:if(t.response===""){r=t.message||"未知网络错误。";break}var s=b.parseJSON(t.response);var n=s.error;switch(t.status){case 400:r="请求报文格式错误。";break;case 401:r="客户端认证授权失败。请重试或提交反馈。";break;case 405:r="客户端请求错误。请重试或提交反馈。";break;case 579:r="资源上传成功，但回调失败。";break;case 599:r="网络连接异常。请重试或提交反馈。";break;case 614:r="文件已存在。";try{s=b.parseJSON(s.error);n=s.error||"file exists"}catch(u){n=s.error||"file exists"}break;case 631:r="指定空间不存在。";break;case 701:r="上传数据块校验出错。请重试或提交反馈。";break;default:r="未知错误。";break}r=r+"("+t.status+"："+n+")";break;case plupload.SECURITY_ERROR:r="安全配置错误。请联系网站管理员。";break;case plupload.GENERIC_ERROR:r="上传失败。请稍后再试。";break;case plupload.IO_ERROR:r="上传失败。请稍后再试。";break;case plupload.INIT_ERROR:r="网站配置错误。请联系网站管理员。";g.destroy();break;default:r=t.message+t.details;break}if(m){m(o,t,r)}}o.refresh()}})(f));g.bind("FileUploaded",(function(m){return function(u,t,s){var p=function(A,B,D){if(h.downtoken_url){var C=b.createAjax();C.open("POST",h.downtoken_url,true);C.setRequestHeader("Content-type","application/x-www-form-urlencoded");C.onreadystatechange=function(){if(C.readyState===4){if(C.status===200){var F;try{F=b.parseJSON(C.responseText)}catch(G){throw ("invalid json format")}var E={};plupload.extend(E,b.parseJSON(D),F);if(m){m(A,B,JSON.stringify(E))}}else{g.trigger("Error",{status:C.status,response:C.responseText,file:B,code:plupload.HTTP_ERROR})}}};C.send("key="+b.parseJSON(D).key+"&domain="+h.domain)}else{if(m){m(A,B,D)}}};var w=b.parseJSON(s.response);k=k?k:w.ctx;if(k){var y="";if(!h.save_key){y=i(u,t,b.key_handler);y=y?"/key/"+b.URLSafeBase64Encode(y):""}var r="/fname/"+b.URLSafeBase64Encode(t.name);var q=h.x_vars,z="",o="";if(q!==undefined&&typeof q==="object"){for(var v in q){if(q.hasOwnProperty(v)){if(typeof q[v]==="function"){z=b.URLSafeBase64Encode(q[v](u,t))}else{if(typeof q[v]!=="object"){z=b.URLSafeBase64Encode(q[v])}}o+="/x:"+v+"/"+z}}}var n=a+"/mkfile/"+t.size+y+r+o;var x=b.createAjax();x.open("POST",n,true);x.setRequestHeader("Content-Type","text/plain;charset=UTF-8");x.setRequestHeader("Authorization","UpToken "+b.token);x.onreadystatechange=function(){if(x.readyState===4){localStorage.removeItem(t.name);if(x.status===200){var A=x.responseText;p(u,t,A)}else{g.trigger("Error",{status:x.status,response:x.responseText,file:t,code:-200})}}};x.send(k)}else{p(u,t,s.response)}}})(l));return g};this.getUrl=function(c){if(!c){return false}c=encodeURI(c);var d=this.domain;if(d.slice(d.length-1)!=="/"){d=d+"/"}return d+c};this.imageView2=function(k,e){var j=k.mode||"",c=k.w||"",f=k.h||"",g=k.q||"",i=k.format||"";if(!j){return false}if(!c&&!f){return false}var d="imageView2/"+j;d+=c?"/w/"+c:"";d+=f?"/h/"+f:"";d+=g?"/q/"+g:"";d+=i?"/format/"+i:"";if(e){d=this.getUrl(e)+"?"+d}return d};this.imageMogr2=function(h,l){var m=h["auto-orient"]||"",c=h.thumbnail||"",d=h.strip||"",n=h.gravity||"",g=h.crop||"",k=h.quality||"",f=h.rotate||"",j=h.format||"",e=h.blur||"";var i="imageMogr2";i+=m?"/auto-orient":"";i+=c?"/thumbnail/"+c:"";i+=d?"/strip":"";i+=n?"/gravity/"+n:"";i+=k?"/quality/"+k:"";i+=g?"/crop/"+g:"";i+=f?"/rotate/"+f:"";i+=j?"/format/"+j:"";i+=e?"/blur/"+e:"";if(l){i=this.getUrl(l)+"?"+i}return i};this.watermark=function(f,j){var g=f.mode;if(!g){return false}var i="watermark/"+g;if(g===1){var d=f.image||"";if(!d){return false}i+=d?"/image/"+this.URLSafeBase64Encode(d):""}else{if(g===2){var k=f.text?f.text:"",c=f.font?f.font:"",h=f.fontsize?f.fontsize:"",n=f.fill?f.fill:"";if(!k){return false}i+=k?"/text/"+this.URLSafeBase64Encode(k):"";i+=c?"/font/"+this.URLSafeBase64Encode(c):"";i+=h?"/fontsize/"+h:"";i+=n?"/fill/"+this.URLSafeBase64Encode(n):""}else{return false}}var e=f.dissolve||"",m=f.gravity||"",o=f.dx||"",l=f.dy||"";i+=e?"/dissolve/"+e:"";i+=m?"/gravity/"+m:"";i+=o?"/dx/"+o:"";i+=l?"/dy/"+l:"";if(j){i=this.getUrl(j)+"?"+i}return i};this.imageInfo=function(d){if(!d){return false}var c=this.getUrl(d)+"?imageInfo";var g=this.createAjax();var f;var e=this;g.open("GET",c,false);g.onreadystatechange=function(){if(g.readyState===4&&g.status===200){f=e.parseJSON(g.responseText)}};g.send();return f};this.exif=function(d){if(!d){return false}var c=this.getUrl(d)+"?exif";var g=this.createAjax();var f;var e=this;g.open("GET",c,false);g.onreadystatechange=function(){if(g.readyState===4&&g.status===200){f=e.parseJSON(g.responseText)}};g.send();return f};this.get=function(d,c){if(!c||!d){return false}if(d==="exif"){return this.exif(c)}else{if(d==="imageInfo"){return this.imageInfo(c)}}return false};this.pipeline=function(f,k){var g=Object.prototype.toString.call(f)==="[object Array]";var e,l,j="";if(g){for(var d=0,h=f.length;d<h;d++){e=f[d];if(!e.fop){return false}switch(e.fop){case"watermark":j+=this.watermark(e)+"|";break;case"imageView2":j+=this.imageView2(e)+"|";break;case"imageMogr2":j+=this.imageMogr2(e)+"|";break;default:l=true;break}if(l){return false}}if(k){j=this.getUrl(k)+"?"+j;var c=j.length;if(j.slice(c-1)==="|"){j=j.slice(0,c-1)}}return j}return false}}var Qiniu=new QiniuJsSDK();
