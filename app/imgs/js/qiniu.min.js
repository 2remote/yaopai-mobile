function QiniuJsSDK(){var a;a="https:"===window.location.protocol?"https://up.qbox.me":"http://upload.qiniu.com",this.detectIEVersion=function(){for(var a=4,b=document.createElement("div"),c=b.getElementsByTagName("i");b.innerHTML="<!--[if gt IE "+a+"]><i></i><![endif]-->",c[0];)a++;return a>4?a:!1},this.isImage=function(a){var b,c="",d=["png","jpg","jpeg","gif","bmp"],e=/\.([a-zA-Z0-9]+)(\?|\@|$)/;if(!a||!e.test(a))return!1;b=e.exec(a),c=b[1].toLowerCase();for(var f=0,g=d.length;g>f;f++)if(c===d[f])return!0;return!1},this.getFileExtension=function(a){var b,c=a.split(".");return b=1===c.length||""===c[0]&&2===c.length?"":c.pop().toLowerCase()},this.utf8_encode=function(a){if(null===a||"undefined"==typeof a)return"";var b,c,d=a+"",e="",f=0;b=c=0,f=d.length;for(var g=0;f>g;g++){var h=d.charCodeAt(g),i=null;if(128>h)c++;else if(h>127&&2048>h)i=String.fromCharCode(h>>6|192,63&h|128);else if(63488&h^!0)i=String.fromCharCode(h>>12|224,h>>6&63|128,63&h|128);else{if(64512&h^!0)throw new RangeError("Unmatched trail surrogate at "+g);var j=d.charCodeAt(++g);if(64512&j^!0)throw new RangeError("Unmatched lead surrogate at "+(g-1));h=((1023&h)<<10)+(1023&j)+65536,i=String.fromCharCode(h>>18|240,h>>12&63|128,h>>6&63|128,63&h|128)}null!==i&&(c>b&&(e+=d.slice(b,c)),e+=i,b=c=g+1)}return c>b&&(e+=d.slice(b,f)),e},this.base64_encode=function(a){var b,c,d,e,f,g,h,i,j="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=",k=0,l=0,m="",n=[];if(!a)return a;a=this.utf8_encode(a+"");do b=a.charCodeAt(k++),c=a.charCodeAt(k++),d=a.charCodeAt(k++),i=b<<16|c<<8|d,e=i>>18&63,f=i>>12&63,g=i>>6&63,h=63&i,n[l++]=j.charAt(e)+j.charAt(f)+j.charAt(g)+j.charAt(h);while(k<a.length);switch(m=n.join(""),a.length%3){case 1:m=m.slice(0,-2)+"==";break;case 2:m=m.slice(0,-1)+"="}return m},this.URLSafeBase64Encode=function(a){return a=this.base64_encode(a),a.replace(/\//g,"_").replace(/\+/g,"-")},this.createAjax=function(a){var b={};return b=window.XMLHttpRequest?new XMLHttpRequest:new ActiveXObject("Microsoft.XMLHTTP")},this.parseJSON=function(a){return window.JSON&&window.JSON.parse?window.JSON.parse(a):null===a?a:"string"==typeof a&&(a=this.trim(a),a&&/^[\],:{}\s]*$/.test(a.replace(/\\(?:["\\\/bfnrt]|u[\da-fA-F]{4})/g,"@").replace(/"[^"\\\r\n]*"|true|false|null|-?(?:\d+\.|)\d+(?:[eE][+-]?\d+|)/g,"]").replace(/(?:^|:|,)(?:\s*\[)+/g,"")))?function(){return a}():void 0},this.trim=function(a){return null===a?"":a.replace(/^\s+|\s+$/g,"")};var b=this;this.uploader=function(c){if(!c.domain)throw"uptoken_url or domain is required!";if(!c.browse_button)throw"browse_button is required!";var d={},e=c.init&&c.init.Error,f=c.init&&c.init.FileUploaded;c.init.Error=function(){},c.init.FileUploaded=function(){},b.uptoken_url=c.uptoken_url,b.token="",b.key_handler="function"==typeof c.init.Key?c.init.Key:"",this.domain=c.domain;var g="",h={isResumeUpload:!1,resumeFilesize:0,startTime:"",currentTime:""},i=function(){var a,d,e,f=b.detectIEVersion(),g="Safari"===mOxie.Env.browser&&mOxie.Env.version<=5&&"Windows"===mOxie.Env.os&&"7"===mOxie.Env.osVersion||"Safari"===mOxie.Env.browser&&"iOS"===mOxie.Env.os&&"7"===mOxie.Env.osVersion;f&&9>=f&&c.chunk_size&&c.runtimes.indexOf("flash")>=0?c.chunk_size=0:g?c.chunk_size=0:(a=20,d=4<<a,e=plupload.parseSize(c.chunk_size),e>d&&(c.chunk_size=d))};i();var j=function(){if(c.uptoken)b.token=c.uptoken;else{var a=b.createAjax();a.open("GET",b.uptoken_url,!0),a.setRequestHeader("If-Modified-Since","0"),a.onreadystatechange=function(){if(4===a.readyState&&200===a.status){var c=b.parseJSON(a.responseText);b.token=c.uptoken}},a.send()}},k=function(a,d,e){var f="",g=!1;if(!c.save_key)if(g=a.getOption&&a.getOption("unique_names"),g=g||a.settings&&a.settings.unique_names){var h=b.getFileExtension(d.name);f=h?d.id+"."+h:d.id}else f="function"==typeof e?e(a,d):d.name;return f};plupload.extend(d,c,{url:a,multipart_params:{token:""}});var l=new plupload.Uploader(d);return l.bind("Init",function(a,b){j()}),l.init(),l.bind("FilesAdded",function(a,b){var c=a.getOption&&a.getOption("auto_start");c=c||a.settings&&a.settings.auto_start,c&&plupload.each(b,function(b,c){a.start()}),a.refresh()}),l.bind("BeforeUpload",function(d,e){e.speed=e.speed||0,g="",c.get_new_uptoken&&j();var f=function(d,e,f){h.startTime=(new Date).getTime();var g;g=c.save_key?{token:b.token}:{key:k(d,e,f),token:b.token};var i=c.x_vars;if(void 0!==i&&"object"==typeof i)for(var j in i)i.hasOwnProperty(j)&&("function"==typeof i[j]?g["x:"+j]=i[j](d,e):"object"!=typeof i[j]&&(g["x:"+j]=i[j]));d.setOption({url:a,multipart:!0,chunk_size:void 0,multipart_params:g})},i=d.getOption&&d.getOption("chunk_size");if(i=i||d.settings&&d.settings.chunk_size,"html5"===l.runtime&&i)if(e.size<i)f(d,e,b.key_handler);else{var m=localStorage.getItem(e.name),n=i;if(m){m=JSON.parse(m);var o=(new Date).getTime(),p=m.time||0,q=864e5;q>o-p&&100!==m.percent&&e.size===m.total?(e.percent=m.percent,e.loaded=m.offset,g=m.ctx,h.isResumeUpload=!0,h.resumeFilesize=m.offset,m.offset+n>e.size&&(n=e.size-m.offset)):localStorage.removeItem(e.name)}h.startTime=(new Date).getTime(),d.setOption({url:a+"/mkblk/"+n,multipart:!1,chunk_size:i,required_features:"chunks",headers:{Authorization:"UpToken "+b.token},multipart_params:{}})}else f(d,e,b.key_handler)}),l.bind("UploadProgress",function(a,b){h.currentTime=(new Date).getTime();var c=h.currentTime-h.startTime,d=b.loaded||0;h.isResumeUpload&&(d=b.loaded-h.resumeFilesize),b.speed=(d/c*1e3).toFixed(0)||0}),l.bind("ChunkUploaded",function(c,d,e){var f=b.parseJSON(e.response);g=g?g+","+f.ctx:f.ctx;var h=e.total-e.offset,i=c.getOption&&c.getOption("chunk_size");i=i||c.settings&&c.settings.chunk_size,i>h&&c.setOption({url:a+"/mkblk/"+h}),localStorage.setItem(d.name,JSON.stringify({ctx:g,percent:d.percent,total:e.total,offset:e.offset,time:(new Date).getTime()}))}),l.bind("Error",function(a){return function(c,d){var e="",f=d.file;if(f){switch(d.code){case plupload.FAILED:e="上传失败。请稍后再试。";break;case plupload.FILE_SIZE_ERROR:var g=c.getOption&&c.getOption("max_file_size");g=g||c.settings&&c.settings.max_file_size,e="浏览器最大可上传"+g+"。更大文件请使用命令行工具。";break;case plupload.FILE_EXTENSION_ERROR:e="文件验证失败。请稍后重试。";break;case plupload.HTTP_ERROR:if(""===d.response){e=d.message||"未知网络错误。";break}var h=b.parseJSON(d.response),i=h.error;switch(d.status){case 400:e="请求报文格式错误。";break;case 401:e="客户端认证授权失败。请重试或提交反馈。";break;case 405:e="客户端请求错误。请重试或提交反馈。";break;case 579:e="资源上传成功，但回调失败。";break;case 599:e="网络连接异常。请重试或提交反馈。";break;case 614:e="文件已存在。";try{h=b.parseJSON(h.error),i=h.error||"file exists"}catch(j){i=h.error||"file exists"}break;case 631:e="指定空间不存在。";break;case 701:e="上传数据块校验出错。请重试或提交反馈。";break;default:e="未知错误。"}e=e+"("+d.status+"："+i+")";break;case plupload.SECURITY_ERROR:e="安全配置错误。请联系网站管理员。";break;case plupload.GENERIC_ERROR:e="上传失败。请稍后再试。";break;case plupload.IO_ERROR:e="上传失败。请稍后再试。";break;case plupload.INIT_ERROR:e="网站配置错误。请联系网站管理员。",l.destroy();break;default:e=d.message+d.details}a&&a(c,d,e)}c.refresh()}}(e)),l.bind("FileUploaded",function(d){return function(e,f,h){var i=function(a,e,f){if(c.downtoken_url){var g=b.createAjax();g.open("POST",c.downtoken_url,!0),g.setRequestHeader("Content-type","application/x-www-form-urlencoded"),g.onreadystatechange=function(){if(4===g.readyState)if(200===g.status){var c;try{c=b.parseJSON(g.responseText)}catch(h){throw"invalid json format"}var i={};plupload.extend(i,b.parseJSON(f),c),d&&d(a,e,JSON.stringify(i))}else l.trigger("Error",{status:g.status,response:g.responseText,file:e,code:plupload.HTTP_ERROR})},g.send("key="+b.parseJSON(f).key+"&domain="+c.domain)}else d&&d(a,e,f)},j=b.parseJSON(h.response);if(g=g?g:j.ctx){var m="";c.save_key||(m=k(e,f,b.key_handler),m=m?"/key/"+b.URLSafeBase64Encode(m):"");var n="/fname/"+b.URLSafeBase64Encode(f.name),o=c.x_vars,p="",q="";if(void 0!==o&&"object"==typeof o)for(var r in o)o.hasOwnProperty(r)&&("function"==typeof o[r]?p=b.URLSafeBase64Encode(o[r](e,f)):"object"!=typeof o[r]&&(p=b.URLSafeBase64Encode(o[r])),q+="/x:"+r+"/"+p);var s=a+"/mkfile/"+f.size+m+n+q,t=b.createAjax();t.open("POST",s,!0),t.setRequestHeader("Content-Type","text/plain;charset=UTF-8"),t.setRequestHeader("Authorization","UpToken "+b.token),t.onreadystatechange=function(){if(4===t.readyState)if(localStorage.removeItem(f.name),200===t.status){var a=t.responseText;i(e,f,a)}else l.trigger("Error",{status:t.status,response:t.responseText,file:f,code:-200})},t.send(g)}else i(e,f,h.response)}}(f)),l},this.getUrl=function(a){if(!a)return!1;a=encodeURI(a);var b=this.domain;return"/"!==b.slice(b.length-1)&&(b+="/"),b+a},this.imageView2=function(a,b){var c=a.mode||"",d=a.w||"",e=a.h||"",f=a.q||"",g=a.format||"";if(!c)return!1;if(!d&&!e)return!1;var h="imageView2/"+c;return h+=d?"/w/"+d:"",h+=e?"/h/"+e:"",h+=f?"/q/"+f:"",h+=g?"/format/"+g:"",b&&(h=this.getUrl(b)+"?"+h),h},this.imageMogr2=function(a,b){var c=a["auto-orient"]||"",d=a.thumbnail||"",e=a.strip||"",f=a.gravity||"",g=a.crop||"",h=a.quality||"",i=a.rotate||"",j=a.format||"",k=a.blur||"",l="imageMogr2";return l+=c?"/auto-orient":"",l+=d?"/thumbnail/"+d:"",l+=e?"/strip":"",l+=f?"/gravity/"+f:"",l+=h?"/quality/"+h:"",l+=g?"/crop/"+g:"",l+=i?"/rotate/"+i:"",l+=j?"/format/"+j:"",l+=k?"/blur/"+k:"",b&&(l=this.getUrl(b)+"?"+l),l},this.watermark=function(a,b){var c=a.mode;if(!c)return!1;var d="watermark/"+c;if(1===c){var e=a.image||"";if(!e)return!1;d+=e?"/image/"+this.URLSafeBase64Encode(e):""}else{if(2!==c)return!1;var f=a.text?a.text:"",g=a.font?a.font:"",h=a.fontsize?a.fontsize:"",i=a.fill?a.fill:"";if(!f)return!1;d+=f?"/text/"+this.URLSafeBase64Encode(f):"",d+=g?"/font/"+this.URLSafeBase64Encode(g):"",d+=h?"/fontsize/"+h:"",d+=i?"/fill/"+this.URLSafeBase64Encode(i):""}var j=a.dissolve||"",k=a.gravity||"",l=a.dx||"",m=a.dy||"";return d+=j?"/dissolve/"+j:"",d+=k?"/gravity/"+k:"",d+=l?"/dx/"+l:"",d+=m?"/dy/"+m:"",b&&(d=this.getUrl(b)+"?"+d),d},this.imageInfo=function(a){if(!a)return!1;var b,c=this.getUrl(a)+"?imageInfo",d=this.createAjax(),e=this;return d.open("GET",c,!1),d.onreadystatechange=function(){4===d.readyState&&200===d.status&&(b=e.parseJSON(d.responseText))},d.send(),b},this.exif=function(a){if(!a)return!1;var b,c=this.getUrl(a)+"?exif",d=this.createAjax(),e=this;return d.open("GET",c,!1),d.onreadystatechange=function(){4===d.readyState&&200===d.status&&(b=e.parseJSON(d.responseText))},d.send(),b},this.get=function(a,b){return b&&a?"exif"===a?this.exif(b):"imageInfo"===a?this.imageInfo(b):!1:!1},this.pipeline=function(a,b){var c,d,e="[object Array]"===Object.prototype.toString.call(a),f="";if(e){for(var g=0,h=a.length;h>g;g++){if(c=a[g],!c.fop)return!1;switch(c.fop){case"watermark":f+=this.watermark(c)+"|";break;case"imageView2":f+=this.imageView2(c)+"|";break;case"imageMogr2":f+=this.imageMogr2(c)+"|";break;default:d=!0}if(d)return!1}if(b){f=this.getUrl(b)+"?"+f;var i=f.length;"|"===f.slice(i-1)&&(f=f.slice(0,i-1))}return f}return!1}}var Qiniu=new QiniuJsSDK;